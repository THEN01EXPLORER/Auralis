from typing import Dict, List, TypedDict

class VulnerabilityPattern(TypedDict):
    id: str
    name: str
    severity: str
    regex: List[str]
    description: str
    recommendation: str
    confidence: float

VULNERABILITY_PATTERNS: List[VulnerabilityPattern] = [
    {
        "id": "REENTRANCY",
        "name": "Re-entrancy Attack",
        "severity": "Critical",
        "regex": [r'\.call{', r'\.call\('],
        "description": "External call detected before state changes. This could allow an attacker to re-enter the function.",
        "recommendation": "Use Checks-Effects-Interactions pattern or ReentrancyGuard.",
        "confidence": 0.95
    },
    {
        "id": "OVERFLOW",
        "name": "Integer Overflow/Underflow",
        "severity": "High",
        "regex": [r'\+\+(?!\s*=)', r'\-\-(?!\s*=)', r'[\+\-\*](?!\s*=)(?!.*unchecked)'],
        "description": "Unchecked arithmetic operation detected.",
        "recommendation": "Use SafeMath library or Solidity 0.8+ built-in checks.",
        "confidence": 0.80
    },
    {
        "id": "ACCESS_CONTROL",
        "name": "Access Control Violation",
        "severity": "Medium", # Often false positive, so medium
        "regex": [r'function\s+\w+\s*\(.*public.*'],
        "description": "Public function without apparent access control modifier found.",
        "recommendation": "Add appropriate access control modifiers (onlyOwner, onlyAdmin) if this function is privileged.",
        "confidence": 0.60 # Lower confidence as it's regex based
    },
    {
        "id": "UNCHECKED_RETURN",
        "name": "Unchecked Return Value",
        "severity": "Medium",
        "regex": [r'\.transfer\(', r'\.send\('],
        "description": "Low-level call used without checking return value.",
        "recommendation": "Check return value or use transfer() which reverts on failure (for .transfer, ensure gas limits are considered).",
        "confidence": 0.85
    },
    {
        "id": "TIMESTAMP_DEPENDENCE",
        "name": "Timestamp Dependence",
        "severity": "Medium",
        "regex": [r'block\.timestamp', r'\bnow\b'],
        "description": "Contract relies on block.timestamp which can be manipulated by miners.",
        "recommendation": "Avoid using timestamps for critical logic like randomness.",
        "confidence": 0.90
    },
    {
        "id": "DELEGATECALL",
        "name": "Delegatecall Injection",
        "severity": "Critical",
        "regex": [r'delegatecall'],
        "description": "Unsafe delegatecall detected - can lead to complete contract takeover.",
        "recommendation": "Validate delegatecall targets and use library pattern to prevent state collision.",
        "confidence": 0.92
    },
    {
        "id": "TX_ORIGIN",
        "name": "Tx Origin Authentication",
        "severity": "High",
        "regex": [r'tx\.origin'],
        "description": "Use of tx.origin for authentication is vulnerable to phishing.",
        "recommendation": "Use msg.sender instead of tx.origin.",
        "confidence": 0.95
    },
    {
        "id": "SELFDESTRUCT",
        "name": "Self Destruct",
        "severity": "High",
        "regex": [r'selfdestruct', r'suicide'],
        "description": "Usage of selfdestruct can be dangerous and is deprecated in newer EVM versions.",
        "recommendation": "Avoid using selfdestruct.",
        "confidence": 0.95
    },
    {
        "id": "HARDCODED_ADDRESS",
        "name": "Hardcoded Address",
        "severity": "Low",
        "regex": [r'0x[a-fA-F0-9]{40}'],
        "description": "Hardcoded address found. This limits flexibility.",
        "recommendation": "Pass addresses as constructor arguments or setter functions.",
        "confidence": 0.70
    },
]
