import pytest
from app.services.vulnerability_merger import VulnerabilityMerger
from app.models.contract import Vulnerability, RemediationDetails


class TestVulnerabilityMerger:
    """Test cases for VulnerabilityMerger service."""
    
    def test_duplicate_detection_same_type_and_line(self):
        """Test duplicate detection with same type and line number."""
        static_vuln = Vulnerability(
            type="Re-entrancy Attack",
            severity="High",
            line=42,
            description="Static analysis description",
            recommendation="Static recommendation",
            confidence=0.8,
            source="static"
        )
        
        ai_vuln = Vulnerability(
            type="Re-entrancy Attack",
            severity="Critical",
            line=42,
            description="AI analysis description",
            recommendation="AI recommendation",
            confidence=0.9,
            source="ai"
        )
        
        # Test that they are detected as duplicates
        assert VulnerabilityMerger._is_duplicate(static_vuln, ai_vuln) == True
    
    def test_no_duplicate_different_type(self):
        """Test that vulnerabilities with different types are not duplicates."""
        vuln1 = Vulnerability(
            type="Re-entrancy Attack",
            severity="High",
            line=42,
            description="Description 1",
            recommendation="Recommendation 1",
            confidence=0.8,
            source="static"
        )
        
        vuln2 = Vulnerability(
            type="Timestamp Dependence",
            severity="Medium",
            line=42,
            description="Description 2",
            recommendation="Recommendation 2",
            confidence=0.7,
            source="ai"
        )
        
        assert VulnerabilityMerger._is_duplicate(vuln1, vuln2) == False
    
    def test_no_duplicate_different_line(self):
        """Test that vulnerabilities with different line numbers are not duplicates."""
        vuln1 = Vulnerability(
            type="Re-entrancy Attack",
            severity="High",
            line=42,
            description="Description 1",
            recommendation="Recommendation 1",
            confidence=0.8,
            source="static"
        )
        
        vuln2 = Vulnerability(
            type="Re-entrancy Attack",
            severity="Critical",
            line=50,
            description="Description 2",
            recommendation="Recommendation 2",
            confidence=0.9,
            source="ai"
        )
        
        assert VulnerabilityMerger._is_duplicate(vuln1, vuln2) == False
    
    def test_severity_prioritization_critical_over_high(self):
        """Test severity prioritization: Critical > High."""
        static_vuln = Vulnerability(
            type="Re-entrancy Attack",
            severity="High",
            line=42,
            description="Static description",
            recommendation="Static recommendation",
            confidence=0.8,
            source="static"
        )
        
        ai_vuln = Vulnerability(
            type="Re-entrancy Attack",
            severity="Critical",
            line=42,
            description="AI description",
            recommendation="AI recommendation",
            confidence=0.9,
            source="ai"
        )
        
        merged = VulnerabilityMerger._merge_two(static_vuln, ai_vuln)
        assert merged.severity == "Critical"
    
    def test_severity_prioritization_high_over_medium(self):
        """Test severity prioritization: High > Medium."""
        static_vuln = Vulnerability(
            type="Timestamp Dependence",
            severity="Medium",
            line=25,
            description="Static description",
            recommendation="Static recommendation",
            confidence=0.7,
            source="static"
        )
        
        ai_vuln = Vulnerability(
            type="Timestamp Dependence",
            severity="High",
            line=25,
            description="AI description",
            recommendation="AI recommendation",
            confidence=0.8,
            source="ai"
        )
        
        merged = VulnerabilityMerger._merge_two(static_vuln, ai_vuln)
        assert merged.severity == "High"
    
    def test_severity_prioritization_medium_over_low(self):
        """Test severity prioritization: Medium > Low."""
        static_vuln = Vulnerability(
            type="Gas Optimization",
            severity="Low",
            line=15,
            description="Static description",
            recommendation="Static recommendation",
            confidence=0.6,
            source="static"
        )
        
        ai_vuln = Vulnerability(
            type="Gas Optimization",
            severity="Medium",
            line=15,
            description="AI description",
            recommendation="AI recommendation",
            confidence=0.7,
            source="ai"
        )
        
        merged = VulnerabilityMerger._merge_two(static_vuln, ai_vuln)
        assert merged.severity == "Medium"
    
    def test_confidence_score_selection_higher_wins(self):
        """Test confidence score selection: higher value wins."""
        static_vuln = Vulnerability(
            type="Access Control",
            severity="High",
            line=30,
            description="Static description",
            recommendation="Static recommendation",
            confidence=0.95,
            source="static"
        )
        
        ai_vuln = Vulnerability(
            type="Access Control",
            severity="High",
            line=30,
            description="AI description",
            recommendation="AI recommendation",
            confidence=0.85,
            source="ai"
        )
        
        merged = VulnerabilityMerger._merge_two(static_vuln, ai_vuln)
        assert merged.confidence == 0.95
    
    def test_description_combination(self):
        """Test description combination with clear attribution."""
        static_vuln = Vulnerability(
            type="Integer Overflow",
            severity="Medium",
            line=20,
            description="Static analysis found overflow",
            recommendation="Static recommendation",
            confidence=0.8,
            source="static"
        )
        
        ai_vuln = Vulnerability(
            type="Integer Overflow",
            severity="High",
            line=20,
            description="AI analysis found overflow",
            recommendation="AI recommendation",
            confidence=0.9,
            source="ai"
        )
        
        merged = VulnerabilityMerger._merge_two(static_vuln, ai_vuln)
        
        # Check that both descriptions are included with attribution
        assert "Static Analysis: Static analysis found overflow" in merged.description
        assert "AI Analysis: AI analysis found overflow" in merged.description
        assert "Static Analysis: Static recommendation" in merged.recommendation
        assert "AI Analysis: AI recommendation" in merged.recommendation
        assert merged.source == "hybrid"
    
    def test_non_duplicate_preservation(self):
        """Test that non-duplicate vulnerabilities are preserved."""
        static_vulns = [
            Vulnerability(
                type="Re-entrancy Attack",
                severity="High",
                line=42,
                description="Static reentrancy",
                recommendation="Fix reentrancy",
                confidence=0.8,
                source="static"
            ),
            Vulnerability(
                type="Access Control",
                severity="Medium",
                line=25,
                description="Static access control",
                recommendation="Fix access control",
                confidence=0.7,
                source="static"
            )
        ]
        
        ai_vulns = [
            Vulnerability(
                type="Business Logic",
                severity="High",
                line=60,
                description="AI business logic",
                recommendation="Fix business logic",
                confidence=0.9,
                source="ai"
            )
        ]
        
        merged = VulnerabilityMerger.merge(static_vulns, ai_vulns)
        
        # Should have all 3 vulnerabilities since none are duplicates
        assert len(merged) == 3
        
        # Check that all original vulnerabilities are preserved
        types = [v.type for v in merged]
        assert "Re-entrancy Attack" in types
        assert "Access Control" in types
        assert "Business Logic" in types
    
    def test_merge_with_duplicates_and_unique(self):
        """Test merging with both duplicates and unique vulnerabilities."""
        static_vulns = [
            Vulnerability(
                type="Re-entrancy Attack",
                severity="High",
                line=42,
                description="Static reentrancy",
                recommendation="Static fix",
                confidence=0.8,
                source="static"
            ),
            Vulnerability(
                type="Access Control",
                severity="Medium",
                line=25,
                description="Static access",
                recommendation="Static access fix",
                confidence=0.7,
                source="static"
            )
        ]
        
        ai_vulns = [
            Vulnerability(
                type="Re-entrancy Attack",  # Duplicate with first static
                severity="Critical",
                line=42,
                description="AI reentrancy",
                recommendation="AI fix",
                confidence=0.9,
                source="ai"
            ),
            Vulnerability(
                type="Business Logic",  # Unique AI vulnerability
                severity="High",
                line=60,
                description="AI business logic",
                recommendation="AI business fix",
                confidence=0.85,
                source="ai"
            )
        ]
        
        merged = VulnerabilityMerger.merge(static_vulns, ai_vulns)
        
        # Should have 3 vulnerabilities: 1 merged + 1 unique static + 1 unique AI
        assert len(merged) == 3
        
        # Find the merged vulnerability
        merged_vuln = next(v for v in merged if v.source == "hybrid")
        assert merged_vuln.type == "Re-entrancy Attack"
        assert merged_vuln.severity == "Critical"  # AI had higher severity
        assert merged_vuln.confidence == 0.9  # AI had higher confidence
        
        # Check unique vulnerabilities are preserved
        types = [v.type for v in merged]
        assert "Access Control" in types
        assert "Business Logic" in types
    
    def test_empty_lists(self):
        """Test merging with empty lists."""
        # Both empty
        result = VulnerabilityMerger.merge([], [])
        assert result == []
        
        # Static empty
        ai_vulns = [
            Vulnerability(
                type="Test",
                severity="Medium",
                line=10,
                description="Test",
                recommendation="Test",
                confidence=0.8,
                source="ai"
            )
        ]
        result = VulnerabilityMerger.merge([], ai_vulns)
        assert len(result) == 1
        assert result[0].type == "Test"
        
        # AI empty
        static_vulns = [
            Vulnerability(
                type="Test",
                severity="High",
                line=20,
                description="Test",
                recommendation="Test",
                confidence=0.9,
                source="static"
            )
        ]
        result = VulnerabilityMerger.merge(static_vulns, [])
        assert len(result) == 1
        assert result[0].type == "Test"
    
    def test_remediation_details_preservation(self):
        """Test that remediation details are properly handled during merge."""
        static_vuln = Vulnerability(
            type="Buffer Overflow",
            severity="High",
            line=35,
            description="Static description",
            recommendation="Static recommendation",
            confidence=0.8,
            source="static",
            remediation=RemediationDetails(
                explanation="Static remediation explanation",
                code_example="static_code_example();"
            )
        )
        
        ai_vuln = Vulnerability(
            type="Buffer Overflow",
            severity="Critical",
            line=35,
            description="AI description",
            recommendation="AI recommendation",
            confidence=0.9,
            source="ai",
            remediation=RemediationDetails(
                explanation="AI remediation explanation",
                code_example="ai_code_example();"
            )
        )
        
        merged = VulnerabilityMerger._merge_two(static_vuln, ai_vuln)
        
        # Should prefer AI remediation when available
        assert merged.remediation is not None
        assert merged.remediation.explanation == "AI remediation explanation"
        assert merged.remediation.code_example == "ai_code_example();"