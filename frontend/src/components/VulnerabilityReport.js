import React, { useState } from 'react';
import '../styles/VulnerabilityReport.css';
import RiskMeter from './RiskMeter';

function VulnerabilityItem({ vuln, getSeverityClass, onLineClick }) {
  const [expanded, setExpanded] = useState(false);
  
  return (
    <div className={`vulnerability-item ${getSeverityClass(vuln.severity)}`}>
      <div className="vuln-header" onClick={() => setExpanded(!expanded)}>
        <div>
          <span className="vuln-type">{vuln.type}</span>
          <span 
            className="vuln-line clickable" 
            onClick={(e) => {
              e.stopPropagation();
              onLineClick(vuln.line);
            }}
          >
            Line {vuln.line} ğŸ”
          </span>
          {vuln.confidence && (
            <span className="vuln-confidence">{Math.round(vuln.confidence)}% confident</span>
          )}
        </div>
        <span className={`vuln-severity ${getSeverityClass(vuln.severity)}`}>
          {vuln.severity}
        </span>
      </div>
      {expanded && (
        <div className="vuln-details">
          <div className="vuln-description">{vuln.description}</div>
          {vuln.recommendation && (
            <div className="vuln-recommendation">
              <strong>ğŸ’¡ Recommendation:</strong> {vuln.recommendation}
            </div>
          )}
          {vuln.remediation && (
            <div className="vuln-remediation">
              <strong>ğŸ”§ How to Fix:</strong>
              <p>{vuln.remediation.explanation}</p>
              {vuln.remediation.code_example && (
                <div className="code-example">
                  <div className="code-example-header">Fixed Code:</div>
                  <pre><code>{vuln.remediation.code_example}</code></pre>
                </div>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  );
}

function VulnerabilityReport({ report, loading, onLineClick }) {
  if (loading) {
    return (
      <div className="report-loading">
        <div className="spinner"></div>
        <p>Analyzing contract with AI...</p>
      </div>
    );
  }

  if (!report) {
    return (
      <div className="report-empty">
        <div className="empty-icon">ğŸ“</div>
        <p>Paste your smart contract code and click Analyze</p>
      </div>
    );
  }

  const getSeverityClass = (severity) => {
    return `severity-${severity.toLowerCase()}`;
  };

  return (
    <div className="vulnerability-report">
      <div className="report-header">
        <h3>ğŸ” Security Analysis</h3>
        {report.analysis_id && (
          <span className="analysis-id">ID: {report.analysis_id.slice(0, 8)}</span>
        )}
      </div>
      
      <RiskMeter score={report.risk_score} />
      
      {report.summary && (
        <div className="summary-box">
          <strong>Summary:</strong> {report.summary}
        </div>
      )}
      
      <div className="vulnerabilities-section">
        <h4>Vulnerabilities Found: {report.vulnerabilities.length}</h4>
        
        {report.vulnerabilities.length === 0 ? (
          <div className="no-vulnerabilities">
            <span className="check-icon">âœ“</span>
            <p>No vulnerabilities detected</p>
          </div>
        ) : (
          <div className="vulnerabilities-list">
            {report.vulnerabilities.map((vuln, index) => (
              <VulnerabilityItem 
                key={index} 
                vuln={vuln} 
                getSeverityClass={getSeverityClass}
                onLineClick={onLineClick}
              />
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

export default VulnerabilityReport;
