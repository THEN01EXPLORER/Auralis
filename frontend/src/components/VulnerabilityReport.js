import React, { useState, memo } from 'react';
import '../styles/VulnerabilityReport.css';
import RiskMeter from './RiskMeter';

const VulnerabilityItem = memo(function VulnerabilityItem({ vuln, getSeverityClass, onLineClick }) {
  const [expanded, setExpanded] = useState(false);
  const [showFix, setShowFix] = useState(false);
  
  return (
    <div className={`vulnerability-item ${getSeverityClass(vuln.severity)}`}>
      <div className="vuln-header" onClick={() => setExpanded(!expanded)}>
        <div>
          <span className="vuln-type">{vuln.type}</span>
          <span 
            className="vuln-line clickable" 
            onClick={(e) => {
              e.stopPropagation();
              onLineClick(vuln.line);
            }}
          >
            Line {vuln.line} üîç
          </span>
          {vuln.confidence && (
            <span className="vuln-confidence">{Math.round(vuln.confidence * 100)}% confident</span>
          )}
          {vuln.source && (
            <span className="vuln-source" title="Detection source">
              {vuln.source === 'ai' ? 'ü§ñ' : vuln.source === 'static' ? 'üìä' : 'üîÑ'} {vuln.source}
            </span>
          )}
        </div>
        <span className={`vuln-severity ${getSeverityClass(vuln.severity)}`}>
          {vuln.severity}
        </span>
      </div>
      {expanded && (
        <div className="vuln-details">
          <div className="vuln-description">{vuln.description}</div>
          {vuln.recommendation && (
            <div className="vuln-recommendation">
              <strong>üí° Recommendation:</strong> {vuln.recommendation}
            </div>
          )}
          {vuln.remediation && (
            <div className="remediation-section">
              <button 
                className="show-fix-button"
                onClick={(e) => {
                  e.stopPropagation();
                  setShowFix(!showFix);
                }}
              >
                {showFix ? '‚ñº Hide Fix' : '‚ñ∂ Show Fix'}
              </button>
              {showFix && (
                <div className="vuln-remediation">
                  <strong>üîß How to Fix:</strong>
                  <p>{vuln.remediation.explanation}</p>
                  {vuln.remediation.code_example && (
                    <div className="code-example">
                      <div className="code-example-header">Fixed Code:</div>
                      <pre><code>{vuln.remediation.code_example}</code></pre>
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  );
});

const SingleFileReport = memo(function SingleFileReport({ report, onLineClick }) {
  const [dismissedInfo, setDismissedInfo] = React.useState(() => {
    return localStorage.getItem('dismissed-ai-info') === 'true';
  });

  const getSeverityClass = (severity) => {
    return `severity-${severity.toLowerCase()}`;
  };

  const handleDismissInfo = () => {
    setDismissedInfo(true);
    localStorage.setItem('dismissed-ai-info', 'true');
  };

  return (
    <>
      <div className="report-header">
        <h3>üîç Security Analysis</h3>
        {report.analysis_id && (
          <span className="analysis-id">ID: {report.analysis_id.slice(0, 8)}</span>
        )}
      </div>
      
      {report.ai_available === false && !dismissedInfo && (
        <div className="info-banner">
          <span className="info-icon">‚ÑπÔ∏è</span>
          <span className="info-text">
            <strong>Static Analysis Mode:</strong> AI analysis is not configured. 
            Static pattern matching is providing comprehensive security analysis.
            {report.analysis_method === 'static' && report.vulnerabilities?.length > 0 && (
              <span className="info-note"> Results are still accurate and reliable.</span>
            )}
          </span>
          <button 
            className="info-dismiss" 
            onClick={handleDismissInfo}
            aria-label="Dismiss this message"
            title="Dismiss"
          >
            √ó
          </button>
        </div>
      )}
      
      <RiskMeter score={report.risk_score} />
      
      <div className="analysis-metadata">
        {report.analysis_method && (
          <div className="metadata-item">
            <span className="metadata-label">Analysis Type:</span>
            <span className="metadata-value">{report.analysis_method}</span>
          </div>
        )}
        {report.processing_time_ms !== undefined && (
          <div className="metadata-item">
            <span className="metadata-label">Processing Time:</span>
            <span className="metadata-value">{report.processing_time_ms}ms</span>
          </div>
        )}
      </div>
      
      {report.summary && (
        <div className="summary-box">
          <strong>Summary:</strong> {report.summary}
        </div>
      )}
      
      <div className="vulnerabilities-section">
        <h4>Vulnerabilities Found: {report.vulnerabilities.length}</h4>
        
        {report.vulnerabilities.length === 0 ? (
          <div className="no-vulnerabilities">
            <span className="check-icon">‚úì</span>
            <p>No vulnerabilities detected</p>
          </div>
        ) : (
          <div className="vulnerabilities-list">
            {report.vulnerabilities.map((vuln, index) => (
              <VulnerabilityItem 
                key={index} 
                vuln={vuln} 
                getSeverityClass={(sev) => `severity-${sev.toLowerCase()}`}
                onLineClick={onLineClick}
              />
            ))}
          </div>
        )}
      </div>
    </>
  );
});

const MultiFileReport = memo(function MultiFileReport({ repoData, onLineClick }) {
  const files = React.useMemo(() => Object.keys(repoData.results || {}), [repoData.results]);
  const [activeFile, setActiveFile] = useState(() => (files.length ? files[0] : null));
  
  React.useEffect(() => {
    if (files.length === 0) {
      setActiveFile(null);
      return;
    }
    if (!activeFile || !files.includes(activeFile)) {
      setActiveFile(files[0]);
    }
  }, [files, activeFile]);

  if (files.length === 0) {
    return (
      <div className="no-files-found">
        <p>No Solidity files found in repository</p>
      </div>
    );
  }

  const currentReport = activeFile ? repoData.results[activeFile] : null;

  return (
    <>
      <div className="repo-summary">
        <h3>üì¶ Repository Analysis</h3>
        <div className="repo-stats">
          <div className="stat-item">
            <span className="stat-label">Files Analyzed:</span>
            <span className="stat-value">{repoData.files_analyzed}</span>
          </div>
          <div className="stat-item">
            <span className="stat-label">Total Vulnerabilities:</span>
            <span className="stat-value">{repoData.total_vulnerabilities}</span>
          </div>
          <div className="stat-item">
            <span className="stat-label">Processing Time:</span>
            <span className="stat-value">{repoData.processing_time_ms}ms</span>
          </div>
        </div>
      </div>

      <div className="file-tabs">
        {files.map((filename) => {
          const fileReport = repoData.results[filename];
          const vulnCount = fileReport.vulnerabilities?.length || 0;
          const hasError = fileReport.error;
          
          return (
            <button
              key={filename}
              className={`file-tab ${activeFile === filename ? 'active' : ''} ${hasError ? 'error' : ''}`}
              onClick={() => setActiveFile(filename)}
            >
              <span className="file-name">{filename.split('/').pop()}</span>
              {!hasError && (
                <span className={`vuln-badge ${vulnCount > 0 ? 'has-vulns' : 'clean'}`}>
                  {vulnCount}
                </span>
              )}
              {hasError && <span className="error-badge">‚ö†Ô∏è</span>}
            </button>
          );
        })}
      </div>

      <div className="file-report-content">
        {!currentReport ? (
          <div className="no-file-selected">
            <p>Select a file to view detailed analysis.</p>
          </div>
        ) : currentReport.error ? (
          <div className="file-error">
            <div className="error-icon">‚ö†Ô∏è</div>
            <h4>Analysis Failed for {activeFile}</h4>
            <p>{currentReport.error}</p>
          </div>
        ) : (
          <SingleFileReport report={currentReport} onLineClick={onLineClick} />
        )}
      </div>
    </>
  );
});

const VulnerabilityReport = memo(function VulnerabilityReport({ report, loading, error, onLineClick, isRepoAnalysis }) {
  if (loading) {
    return (
      <div className="report-loading">
        <div className="spinner"></div>
        <p>{isRepoAnalysis ? 'Cloning and analyzing repository...' : 'Analyzing contract with AI...'}</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="report-error">
        <div className="error-icon">‚ö†Ô∏è</div>
        <h3>Analysis Failed</h3>
        <p className="error-message">{error}</p>
        <p className="error-hint">Please try again or check your backend connection.</p>
      </div>
    );
  }

  if (!report) {
    return (
      <div className="report-empty">
        <div className="empty-icon">üõ°Ô∏è</div>
        <h3>Auralis is ready to secure your code</h3>
        <p>Paste your contract in the editor or enter a GitHub URL to begin.</p>
        <div className="empty-features">
          <div className="feature-item">üîç AI-Powered Analysis</div>
          <div className="feature-item">‚ö° Real-Time Results</div>
          <div className="feature-item">üîß Smart Remediation</div>
        </div>
      </div>
    );
  }

  return (
    <div className="vulnerability-report">
      {isRepoAnalysis && report.results ? (
        <MultiFileReport repoData={report} onLineClick={onLineClick} />
      ) : (
        <SingleFileReport report={report} onLineClick={onLineClick} />
      )}
    </div>
  );
});

export default VulnerabilityReport;
