import React, { useState, memo, useCallback } from 'react';
import '../styles/VulnerabilityReport.css';
import RiskMeter from './RiskMeter';

const API_URL = process.env.REACT_APP_API_URL || 'http://localhost:8000';

// Severity tooltips explaining what each level means
const SEVERITY_TOOLTIPS = {
  Critical: "üî¥ Critical: Immediate exploitation risk. Can lead to complete loss of funds or contract control. Must fix before deployment.",
  High: "üü† High: Serious vulnerability that could be exploited. Significant financial or security impact. Should be fixed urgently.",
  Medium: "üü° Medium: Potential security issue that could be exploited under specific conditions. Should be addressed.",
  Low: "üü¢ Low: Minor issue or best practice violation. Low immediate risk but recommended to fix."
};

const VulnerabilityItem = memo(function VulnerabilityItem({ vuln, getSeverityClass, onLineClick }) {
  const [expanded, setExpanded] = useState(false);
  const [showFix, setShowFix] = useState(false);
  
  const severity = vuln.severity || 'Low';
  
  return (
    <div className={`vulnerability-item ${getSeverityClass(severity)}`}>
      <div className="vuln-header" onClick={() => setExpanded(!expanded)}>
        <div>
          <span className="vuln-type">{vuln.type || 'Unknown Issue'}</span>
          <span 
            className="vuln-line clickable" 
            onClick={(e) => {
              e.stopPropagation();
              onLineClick(vuln.line);
            }}
          >
            Line {vuln.line || '?'} üîç
          </span>
          {vuln.confidence && (
            <span className="vuln-confidence">{Math.round(vuln.confidence * 100)}% confident</span>
          )}
          {vuln.source && (
            <span className="vuln-source" title="Detection source">
              {vuln.source === 'ai' ? 'ü§ñ' : vuln.source === 'static' ? 'üìä' : 'üîÑ'} {vuln.source}
            </span>
          )}
        </div>
        <span 
          className={`vuln-severity ${getSeverityClass(severity)}`}
          title={SEVERITY_TOOLTIPS[severity] || severity}
        >
          {severity}
        </span>
      </div>
      {expanded && (
        <div className="vuln-details">
          <div className="vuln-description">{vuln.description}</div>
          {vuln.recommendation && (
            <div className="vuln-recommendation">
              <strong>üí° Recommendation:</strong> {vuln.recommendation}
            </div>
          )}
          {vuln.remediation && (
            <div className="remediation-section">
              <button 
                className="show-fix-button"
                onClick={(e) => {
                  e.stopPropagation();
                  setShowFix(!showFix);
                }}
              >
                {showFix ? '‚ñº Hide Fix' : '‚ñ∂ Show Fix'}
              </button>
              {showFix && (
                <div className="vuln-remediation">
                  <strong>üîß How to Fix:</strong>
                  <p>{vuln.remediation.explanation}</p>
                  {vuln.remediation.code_example && (
                    <div className="code-example">
                      <div className="code-example-header">Fixed Code:</div>
                      <pre><code>{vuln.remediation.code_example}</code></pre>
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  );
});

const SingleFileReport = memo(function SingleFileReport({ report, onLineClick, contractCode }) {
  const [dismissedInfo, setDismissedInfo] = React.useState(() => {
    return localStorage.getItem('dismissed-ai-info') === 'true';
  });
  const [exporting, setExporting] = useState(false);

  const getSeverityClass = (severity) => {
    return `severity-${(severity || 'low').toLowerCase()}`;
  };

  const handleDismissInfo = () => {
    setDismissedInfo(true);
    localStorage.setItem('dismissed-ai-info', 'true');
  };

  const handleExport = useCallback(async (format) => {
    if (exporting) return;
    setExporting(true);
    
    try {
      const exportData = {
        analysis_id: report.analysis_id || 'unknown',
        risk_score: report.risk_score || 0,
        vulnerabilities: report.vulnerabilities.map(v => ({
          type: v.type,
          severity: v.severity,
          line: v.line,
          confidence: v.confidence ? Math.round(v.confidence * 100) : 50,
          description: v.description || '',
          recommendation: v.recommendation || v.remediation?.explanation || ''
        })),
        summary: report.summary || `Found ${report.vulnerabilities.length} vulnerabilities`,
        contract_code: contractCode || null,
        format: format
      };

      const response = await fetch(`${API_URL}/api/v1/export`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(exportData)
      });

      if (!response.ok) {
        throw new Error('Export failed');
      }

      // Get the filename from Content-Disposition header or generate one
      const contentDisposition = response.headers.get('Content-Disposition');
      let filename = `auralis_report.${format === 'markdown' ? 'md' : format}`;
      if (contentDisposition) {
        const match = contentDisposition.match(/filename=(.+)/);
        if (match) filename = match[1];
      }

      // Download the file
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    } catch (err) {
      console.error('Export error:', err);
      alert('Failed to export report. Please try again.');
    } finally {
      setExporting(false);
    }
  }, [report, contractCode, exporting]);

  return (
    <>
      <div className="report-header">
        <h3>üîç Security Analysis</h3>
        <div className="report-header-actions">
          {report.analysis_id && (
            <span className="analysis-id">ID: {report.analysis_id.slice(0, 8)}</span>
          )}
          {report.vulnerabilities && report.vulnerabilities.length > 0 && (
            <div className="export-buttons">
              <button 
                className="export-btn export-json"
                onClick={() => handleExport('json')}
                disabled={exporting}
                title="Export as JSON"
              >
                üìÑ JSON
              </button>
              <button 
                className="export-btn export-md"
                onClick={() => handleExport('markdown')}
                disabled={exporting}
                title="Export as Markdown"
              >
                üìù MD
              </button>
              <button 
                className="export-btn export-txt"
                onClick={() => handleExport('txt')}
                disabled={exporting}
                title="Export as Text"
              >
                üìã TXT
              </button>
            </div>
          )}
        </div>
      </div>
      
      {report.ai_available === false && !dismissedInfo && (
        <div className="info-banner">
          <span className="info-icon">üîç</span>
          <span className="info-text">
            <strong>Pattern-Based Analysis:</strong> Using 20 vulnerability detection patterns for comprehensive security scanning.
            {report.vulnerabilities?.length > 0 && (
              <span className="info-note"> Analysis complete and accurate.</span>
            )}
          </span>
          <button 
            className="info-dismiss" 
            onClick={handleDismissInfo}
            aria-label="Dismiss this message"
            title="Dismiss"
          >
            √ó
          </button>
        </div>
      )}
      
      <RiskMeter score={report.risk_score} />
      
      <div className="analysis-metadata">
        {report.analysis_method && (
          <div className="metadata-item">
            <span className="metadata-label">Analysis Type:</span>
            <span className="metadata-value">{report.analysis_method}</span>
          </div>
        )}
        {report.processing_time_ms !== undefined && (
          <div className="metadata-item">
            <span className="metadata-label">Processing Time:</span>
            <span className="metadata-value">{report.processing_time_ms}ms</span>
          </div>
        )}
      </div>
      
      {report.summary && (
        <div className="summary-box">
          <strong>Summary:</strong> {report.summary}
        </div>
      )}
      
      <div className="vulnerabilities-section">
        <h4>Vulnerabilities Found: {report.vulnerabilities.length}</h4>
        
        {report.vulnerabilities.length === 0 ? (
          <div className="no-vulnerabilities">
            <span className="check-icon">‚úì</span>
            <p>No vulnerabilities detected</p>
          </div>
        ) : (
          <div className="vulnerabilities-list">
            {report.vulnerabilities.map((vuln, index) => (
              <VulnerabilityItem 
                key={index} 
                vuln={vuln} 
                getSeverityClass={(sev) => `severity-${(sev || 'low').toLowerCase()}`}
                onLineClick={onLineClick}
              />
            ))}
          </div>
        )}
      </div>
    </>
  );
});

const MultiFileReport = memo(function MultiFileReport({ repoData, onLineClick }) {
  const files = React.useMemo(() => Object.keys(repoData.results || {}), [repoData.results]);
  const [activeFile, setActiveFile] = useState(() => (files.length ? files[0] : null));
  
  React.useEffect(() => {
    if (files.length === 0) {
      setActiveFile(null);
      return;
    }
    if (!activeFile || !files.includes(activeFile)) {
      setActiveFile(files[0]);
    }
  }, [files, activeFile]);

  const currentReport = activeFile ? repoData.results[activeFile] : null;

  // Normalize report data if it's just an array of vulnerabilities (from backend list[dict])
  const normalizedReport = React.useMemo(() => {
    if (!currentReport) return null;
    if (Array.isArray(currentReport)) {
      return {
        vulnerabilities: currentReport,
        risk_score: 0, // Backend doesn't calculate per-file risk score in repo mode yet
        summary: `Found ${currentReport.length} vulnerabilities in this file.`,
        analysis_id: 'repo-scan',
        ai_available: false
      };
    }
    return currentReport;
  }, [currentReport]);

  return (
    <>
      <div className="repo-summary">
        <h3>üì¶ Repository Analysis</h3>
        <div className="repo-stats">
          <div className="stat-item">
            <span className="stat-label">Files Analyzed:</span>
            <span className="stat-value">{repoData.files_analyzed}</span>
          </div>
          <div className="stat-item">
            <span className="stat-label">Total Vulnerabilities:</span>
            <span className="stat-value">{repoData.total_vulnerabilities}</span>
          </div>
          <div className="stat-item">
            <span className="stat-label">Processing Time:</span>
            <span className="stat-value">{repoData.processing_time_ms}ms</span>
          </div>
        </div>
      </div>

      {files.length === 0 ? (
        <div className="no-files-found">
          <p>No Solidity files found in repository</p>
        </div>
      ) : (
        <div className="file-tabs">
        {files.map((filename) => {
          const fileReport = repoData.results[filename];
          // Handle both array (vulnerabilities list) and object (full report or error)
          const vulnCount = Array.isArray(fileReport) 
            ? fileReport.length 
            : (fileReport.vulnerabilities?.length || 0);
          const hasError = !Array.isArray(fileReport) && fileReport.error;
          
          return (
            <button
              key={filename}
              className={`file-tab ${activeFile === filename ? 'active' : ''} ${hasError ? 'error' : ''}`}
              onClick={() => setActiveFile(filename)}
            >
              <span className="file-name">{filename.split('/').pop()}</span>
              {!hasError && (
                <span className={`vuln-badge ${vulnCount > 0 ? 'has-vulns' : 'clean'}`}>
                  {vulnCount}
                </span>
              )}
              {hasError && <span className="error-badge">‚ö†Ô∏è</span>}
            </button>
          );
        })}
      </div>
      )}

      <div className="file-report-content">
        {!normalizedReport ? (
          <div className="no-file-selected">
            <p>Select a file to view detailed analysis.</p>
          </div>
        ) : normalizedReport.error ? (
          <div className="file-error">
            <div className="error-icon">‚ö†Ô∏è</div>
            <h4>Analysis Failed for {activeFile}</h4>
            <p>{normalizedReport.error}</p>
          </div>
        ) : (
          <SingleFileReport report={normalizedReport} onLineClick={onLineClick} />
        )}
      </div>
    </>
  );
});

const VulnerabilityReport = memo(function VulnerabilityReport({ report, loading, error, onLineClick, isRepoAnalysis, contractCode }) {
  if (loading) {
    return (
      <div className="report-loading">
        <div className="spinner"></div>
        <p>{isRepoAnalysis ? 'Cloning and analyzing repository...' : 'Analyzing contract with AI...'}</p>
      </div>
    );
  }

  if (error) {
    const errorMessage = typeof error === 'string' ? error : error.message || 'Unknown error occurred';
    return (
      <div className="report-error">
        <div className="error-icon">‚ö†Ô∏è</div>
        <h3>Analysis Failed</h3>
        <p className="error-message">{errorMessage}</p>
        <p className="error-hint">Please try again or check your backend connection.</p>
      </div>
    );
  }

  if (!report) {
    return (
      <div className="report-empty">
        <div className="empty-icon">üõ°Ô∏è</div>
        <h3>Auralis is ready to secure your code</h3>
        <p>Paste your contract in the editor or enter a GitHub URL to begin.</p>
        <div className="empty-features">
          <div className="feature-item">üîç AI-Powered Analysis</div>
          <div className="feature-item">‚ö° Real-Time Results</div>
          <div className="feature-item">üîß Smart Remediation</div>
        </div>
      </div>
    );
  }

  return (
    <div className="vulnerability-report">
      {isRepoAnalysis && report.results ? (
        <MultiFileReport repoData={report} onLineClick={onLineClick} />
      ) : (
        <SingleFileReport report={report} onLineClick={onLineClick} contractCode={contractCode} />
      )}
    </div>
  );
});

export default VulnerabilityReport;
