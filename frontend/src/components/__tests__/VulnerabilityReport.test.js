import React from 'react';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import VulnerabilityReport from '../VulnerabilityReport';

describe('VulnerabilityReport', () => {
  test('renders empty state when no report', () => {
    render(
      <VulnerabilityReport 
        report={null} 
        loading={false} 
        error={null}
        onLineClick={jest.fn()}
      />
    );
    expect(screen.getByText(/Auralis is ready to secure your code/i)).toBeInTheDocument();
  });

  test('renders loading state', () => {
    render(
      <VulnerabilityReport 
        report={null} 
        loading={true} 
        error={null}
        onLineClick={jest.fn()}
      />
    );
    expect(screen.getByText(/Analyzing contract with AI/i)).toBeInTheDocument();
  });

  test('renders error state', () => {
    const errorMessage = 'Failed to analyze contract';
    render(
      <VulnerabilityReport 
        report={null} 
        loading={false} 
        error={errorMessage}
        onLineClick={jest.fn()}
      />
    );
    expect(screen.getByText('Analysis Failed')).toBeInTheDocument();
    expect(screen.getByText(errorMessage)).toBeInTheDocument();
  });

  test('renders report with vulnerabilities', () => {
    const report = {
      analysis_id: 'test-123',
      risk_score: 85,
      vulnerabilities: [
        {
          type: 'Re-entrancy',
          line: 10,
          severity: 'Critical',
          confidence: 0.95,
          description: 'Test vulnerability',
          recommendation: 'Fix this issue'
        }
      ],
      summary: 'Test summary',
      analysis_method: 'hybrid',
      ai_available: true,
      processing_time_ms: 1000
    };

    render(
      <VulnerabilityReport 
        report={report} 
        loading={false} 
        error={null}
        onLineClick={jest.fn()}
      />
    );

    expect(screen.getByText('Re-entrancy')).toBeInTheDocument();
    expect(screen.getByText('Critical')).toBeInTheDocument();
    expect(screen.getByText(/Test summary/i)).toBeInTheDocument();
  });

  test('renders no vulnerabilities message when list is empty', () => {
    const report = {
      analysis_id: 'test-123',
      risk_score: 0,
      vulnerabilities: [],
      summary: 'No issues found',
      analysis_method: 'static',
      ai_available: true,
      processing_time_ms: 500
    };

    render(
      <VulnerabilityReport 
        report={report} 
        loading={false} 
        error={null}
        onLineClick={jest.fn()}
      />
    );

    expect(screen.getByText(/No vulnerabilities detected/i)).toBeInTheDocument();
  });

  test('displays warning banner when AI is unavailable', () => {
    const report = {
      analysis_id: 'test-123',
      risk_score: 50,
      vulnerabilities: [],
      summary: 'Static analysis only',
      analysis_method: 'static',
      ai_available: false,
      processing_time_ms: 300
    };

    render(
      <VulnerabilityReport 
        report={report} 
        loading={false} 
        error={null}
        onLineClick={jest.fn()}
      />
    );

    expect(screen.getByText(/Static Analysis Mode/i)).toBeInTheDocument();
  });

  test('calls onLineClick when line number is clicked', async () => {
    const onLineClick = jest.fn();
    const report = {
      analysis_id: 'test-123',
      risk_score: 85,
      vulnerabilities: [
        {
          type: 'Re-entrancy',
          line: 10,
          severity: 'Critical',
          confidence: 0.95,
          description: 'Test vulnerability',
          recommendation: 'Fix this issue'
        }
      ],
      summary: 'Test summary',
      analysis_method: 'hybrid',
      ai_available: true,
      processing_time_ms: 1000
    };

    render(
      <VulnerabilityReport 
        report={report} 
        loading={false} 
        error={null}
        onLineClick={onLineClick}
      />
    );

    const lineLink = screen.getByText(/Line 10/i);
    await userEvent.click(lineLink);
    expect(onLineClick).toHaveBeenCalledWith(10);
  });

  test('renders repository analysis when isRepoAnalysis is true', () => {
    const report = {
      repository_url: 'https://github.com/test/repo',
      files_analyzed: 3,
      total_vulnerabilities: 5,
      processing_time_ms: 5000,
      results: {
        'contract1.sol': {
          analysis_id: 'test-1',
          risk_score: 75,
          vulnerabilities: [],
          summary: 'File 1 summary',
          analysis_method: 'hybrid',
          ai_available: true,
          processing_time_ms: 1000
        }
      }
    };

    render(
      <VulnerabilityReport 
        report={report} 
        loading={false} 
        error={null}
        onLineClick={jest.fn()}
        isRepoAnalysis={true}
      />
    );

    expect(screen.getByText(/Repository Analysis/i)).toBeInTheDocument();
    expect(screen.getByText(/Files Analyzed/i)).toBeInTheDocument();
  });
});
